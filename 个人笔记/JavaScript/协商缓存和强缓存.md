# 协商缓存和强缓存

## 1、前言

​	浏览器向服务器请求资源的时候，**许多静态的资源是长时间不会更改的**。重复发送不断从服务器获取不变的静态资源不仅浪费带宽还增加了服务器的压力，影响用户体验。因此使用http缓存就能设置资源缓存，从而<font color=deepred>减少资源请求、减少响应时间</font>。



## 2、http缓存

- 客户端向服务器发送请求时，会根据HTTP响应头的字段加载缓存的资源。
- http缓存分为**强缓存**和**协商缓存**：
  - 相同点：无论哪种都是**从客户端本地加载**；
  - 不同点：协商缓存会向服务器发送请求，强缓存不会发起请求。



### （1）强缓存

- 发生位置：<font color=blue>浏览器客户端</font>
- 是否发送请求：**不请求**服务器
- 策略机制：使用强缓存策略时，如果缓存资源有效，则直接使用缓存资源
- 状态码：命中后<font color=deepred>返回状态码是200</font>
- 强缓存需要配置响应头中的`Cache-Control`属性（http1.1）和`Expires`属性（http1.0）

`Cache-Control`属性值：

```js
1.public：资源可以被任意对象缓存（客户端、代理服务器等）
2.private：资源只能在客户端缓存
3.max-age=xx：设置资源缓存的有效期，超时会发起请求（单位秒）
4.no-cache：设置了该字段需要先和服务端确认返回的资源是否发生了变化，如果资源未发生变化，则直接使用缓存好的资源(走协商缓存)；
5.no-store：禁止任何缓存，每次都会向服务端发起新的请求，拉取最新的资源
```



### （2）协商缓存

- 发生位置：<font color=blue>服务器端</font>
- 是否发送请求：**请求**服务器
- 策略机制：使用协商缓存策略时，会先向服务器发送一个请求，如果资源没有发生修改就让浏览器使用本地的缓存副本；如果资源发生了修改，则返回修改后的资源
- 状态码：命中后<font color=deepred>返回的状态码是304</font>
- 协商缓存需要配置响应头中的`Etag`属性和`Last-Modified`属性
  - （1）服务器通过在响应头中添加`Last-Modified`属性指出资源最后一次修改的时间，当浏览器下一次发送请求时，会在请求头中添加一个`If-Modified-Since`的属性，属性值为上一次资源返回时的`Last-Modified`的值。当请求发送到服务器后服务器会通过这个属性来和资源的最后一次的修改时间来进行比较，以此来判断资源是否做了修改。如果资源没有修改，那么返回 304 状态，让客户端使用本地的缓存。如果资源已经被修改了，则返回修改后的资源。使用这种方法有一个缺点，就是`Last-Modified`标注的最后修改时间只能精确到秒级，如果某些文件在1秒钟以内，被修改多次的话，那么文件已将改变了但是Last-Modified`却没有改变，这样会造成缓存命中的不准确。
  - （2）因为`Last-Modified`的这种可能发生的不准确性，http 中提供了另外一种方式，那就是 Etag 属性。服务器在返回资源的时候，在头信息中添加了 Etag 属性，这个属性是资源生成的唯一标识符，当资源发生改变的时候，这个值也会发生改变。在下一次资源请求时，浏览器会在请求头中添加一个`If-None-Match`属性，这个属性的值就是上次返回的资源的 Etag 的值。服务接收到请求后会根据这个值来和资源当前的 Etag 的值来进行比较，以此来判断资源是否发生改变，是否需要返回资源。通过这种方式，比 Last-Modified 的方式更加精确。低于一秒更精确。

注意⚠️：当 Last-Modified 和 Etag 属性同时出现的时候，Etag 的优先级更高。但是每个服务器上 Etag 的值都不一样，因此在考虑负载平衡时，最好不要设置 Etag 属性。如果不想命中协商缓存和强缓存，win系统使用`ctrl + F5`或`ctrl + shift + r`



### （3）对比

#### 3.1、相同点

强缓存策略和协商缓存策略在缓存命中时都会直接使用本地缓存内容；



#### 3.2、不同点

协商缓存会向服务器发送一次请求，强缓存不会发请求；



在实际缓存机制中强缓存策略和协商缓存策略时一起使用的。浏览器首先会根据请求的信息判断是否是强缓存，如果是就直接使用缓存资源；如果不是则根据请求头信息向服务器发送请求，使用协商缓存，如果协商缓存命中的话，服务器不返回资源，浏览器直接使用本地资源，如果没命中服务器就返回最新的资源给浏览器。

![image-20230117102129890](https://raw.githubusercontent.com/Rainchen0504/picture/master/202301171021007.png)



## 3、浏览器缓存

浏览器缓存分为：<font color=deepred>内存缓存</font>和<font color=deepred>硬盘缓存</font>

一般操作频繁的文件都缓存在内存中，加载非常迅速，操作不频繁的会缓存在硬盘中，加载速度较慢。具体存储位置取决于一定的算法机制。

| 区别     | 内存缓存         | 硬盘缓存         |
| -------- | ---------------- | ---------------- |
| 存储内容 | JS、字体、图片等 | CSS等            |
| 读取速度 | 快               | 慢               |
| 时效性   | 进程关闭则清空   | 可以缓存较长时间 |
| 空间     | 空间小           | 空间大           |

