<center><h1>问卷系统类项目</h1></center>

## 一、代码部分

# 	问卷项目都是sdcd-java下辖的不同分支，不同项目的差异体现在业务下发流程的不同或者填报方式的不同。目前食品安全、专项调查平台、维度问卷项目的主要分支有以下几种。

![image-20220725160429067](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251604661.png)



### 1、项目代码结构（以专项调查平台举例）

![image-20220721095539074](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207211138845.png)

| 目录            | 模块             | 作用                                                         |
| --------------- | ---------------- | ------------------------------------------------------------ |
| ques-core       | 所有题目部分代码 | 新增、编辑、预览、查看题目页面html和js文件，包括所有题型的实现方法； |
| sdcd-client-web | 填报端           | 问卷下发后扫码或登录进入的填报系统（分vue和js版本）；        |
| sdcd-core       | 后台文件         | 后台java部分，包含预览、查看时的模板部分；                   |
| sdcd-manage-web | 管理端           | 后台管理系统，可创建、编辑、分析、审核问卷，管理调查员和名录信息，内置问卷和直报两个业务模块； |
| sdcd-web        | 数据库配置       | Maven配置文件位置，启动连接后台数据库；                      |



### 2、管理端

<mark>位置：sdcd-manage-web-vue/src</mark>

<img src="/Users/rain_chen/Library/Application Support/typora-user-images/image-20220331103150061.png" alt="image-20220331103150061" style="zoom:67%;" />

#### 2.1、管理端问卷

问卷模块包括问卷管理和调查员管理两个模块

​	问卷管理用于新增、编辑、从模板新增、删除、进入管理具体问卷入口的功能；

​	调查员管理用于创建、导入和导出调查员名录，并可重置密码，调查员账号可用于登录填报端系统填报问卷；

对应代码结构如下：

![image-20220725103907452](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251039788.png)

#### 2.2、管理端直报

直报模块包括直报管理和名录库两个模块

​	直报管理用于新增、编辑、从模板新增、删除、进入管理具体直报入口的功能；

​	名录库用于创建、导入和导出个人和企业名录，并可重置密码，名录库账号可用于登录填报端系统填报直报；

对应代码结构如下：

![image-20220725104748858](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251047856.png)



### 3、ques-core

从管理端无论是问卷还是直报模块只要进入新增、编辑、查看、审核即进入该部分代码：

<mark>位置：ques-core/src/main/webapp/assets.quescore.modular.ques/</mark>

#### 3.1、目录结构

#### <img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207211138160.png" alt="image-20220721100610874" style="zoom:67%;" />



#### 3.2、模板部分

​	模板部分包含题型新增页面和h5、pc预览页面的静态结构。

![image-20220721100821144](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207211138799.png)



#### 3.3、js部分

​	配题页面所有题型均由js目录下sub文件中的js动态生成；而预览回显时结构部分由java目录下的subject文件生成，但逻辑和方法由js目录下的js提供。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207211138478.png" alt="image-20220721104135539" style="zoom: 50%;" />

​		所有题型文件均在sub文件夹下：

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251445713.png" alt="image-20220721110629107" style="zoom:67%;" />

#### 3.4、维护流程

##### （1）现有题目加载

以单选题为例，其他题目根据const.js文件进入对应文件，加载流程类似

###### （1.1）新建、编辑时：

![image-20220725144440826](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251444324.png)

- 打开”配置页面“

​	首先进入到模板目录下的`ques_add.html`文件中，该页面按照从上到下的加载顺序将下列资源依次引入进来，这些文件包括所有题目的构造函数、数据的通用处理方法、问卷"舞台"等内容，加载完成后就生成了我们所看到的配置页面。

![image-20220721113727247](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207211138971.png)

- 添加题目

​	点击单选题，这时会进入到引入的radio.js文件中，创建RadioClass类，添加部分私有属性，将题目类型和const文件中定义的变量绑定起来，并设置默认传入的属性参数

![image-20220725095655493](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207250956776.png)

- 第一次继承继承

RadioClass继承了`chose.js`文件中的选择题基类`ChoseClass`，进入chose文件内容如下：

![image-20220725085639333](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207250856060.png)

1. 首先根据题型是否需要逻辑，设置logic的值，可控制每道题左侧工具栏是否显示逻辑配置项；
2. 接着继承sub文件中的题目基类`SubClass`，获取更多属性；

- 第二次继承

SubClass是每道题都要实例化的一个基类对象，在此构造函数中，对添加的题目：

​	设置了题目编号、id，创建题目外层div容器；

​	将从`chose`基类中传入的的DefaultAttr（题目标题、默认选项）解析并赋值到题目或选项位置上；

​	题目展示部分和配置部分块的创建和显示隐藏方法的绑定；

​	题目配置部分确定、取消按钮及事件绑定；

​	左侧工具栏创建，上移、删除、逻辑设置弹窗实现和逻辑方法绑定；

​	将外部引入的富文本编辑器实例化到标题位置；

​	高级设置容器块创建及边框等布局设置；

- 执行后续设置

继承SubClass后，回到ChoseClass继续执行后续方法：

​	创建选项信息，调用option文件中的options基类给每条选项添加属性（选项编码、文本、id、必填等）；

​	将选项块显示在题目容器对应块下；

​	将选项编辑块显示在题目容器对应块下；

​	在高级设置容器中创建高级设置内容并绑定对应方法；

​	构建保存方法，当保存时执行该方法（保存选项、配置项、逻辑等信息）；

- 工厂注册

最后将选择题基类实例化，使用工厂注册方法将题目push添加到全局que对象下。



###### （1.2）查看、预览、审核时：

- 题目回显

![image-20220725100958013](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251009113.png)

回显时，依赖两部分内容

- 第一部分

  在java中所有题目均有对应的文件，该部分提供了回显时的页面结构和填写值、方法的挂载；

![image-20220725101208040](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251012479.png)

- 第二部分

  ​	js目录下的que.js和common.js文件提供了回显时的方法和dom操作，java结构可通过<font color=red>common.方法</font>的方式从该部分获取填写值及注册的事件。

  该部分主要的事件有以下几个：

填写验证：

![image-20220725102230015](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251022313.png)

填写值获取：

![image-20220725102326915](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251023133.png)

数据会写：

![image-20220725102354296](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251023632.png)

以上方法不详述，都是通过操作dom获取和执行方法。



##### （2）增加题型操作

如果有新题型要添加，基本操作流程主要有以下几点：

1. 在`js/sub`文件夹中添加新题型的js文件；
2. 进入新题型js，创建构造函数，继承对应题目基类，同时创建私有方法和属性；
3. 创建完构造函数后进行工厂注册，创建新题型实例；
4. 在const文件中添加新题型题号；
5. 进入`ques_add`文件，将新题型文件引入；
6. 在java中创建新题型回显dom结构，并根据需要设置可存值的属性名等；
7. 进入`js/que.js`文件中，根据java中dom结构分别设置校验、存值、回写方法；

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251534883.png" alt="image-20220725153407209" style="zoom:80%;" />



#### 3.5、题目类继承关系

![image-20220725141432766](https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251558999.png)



### 4、填报端

​	目前填报端有两种，一种是vue版本，一种是java和js结合的版本（此版本和ques_core中预览、查看实现方式相同），此处只展示vue版本的代码目录结构，所有的题目和逻辑都写在questionary目录下的indexQue文件中。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251536193.png" alt="image-20220331101736089" style="zoom: 50%;" />

结构部分依次是各题目结构，只需根据注释内容查找即可

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251539146.png" alt="image-20220725153913729" style="zoom: 67%;" />

方法部分内容较多，可根据注释查看对应方法和实现效果：

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202207251541287.png" alt="image-20220725154142082" style="zoom:80%;" />





## 二、业务流程（以维度问卷为例）

​	维度问卷3.0项目可适用两大业务场景，涵盖不定项调查（问卷系统）和定向调查（直报系统），下面分别对两大系统进行说明。

说明之前首先对维度问卷系统主要存在的角色做一个罗列

| **角色** | **部门主管**                                                 | **普通用户** | **协管员** | **调查员** |
| -------- | ------------------------------------------------------------ | ------------ | ---------- | ---------- |
| 系统管理 | 添加、修改用户、重置密码                                     | 无           | 无         | 无         |
| 问卷系统 | 问卷管理、调查员管理、问卷进度、下发任务、发布问卷、二维码管理、答卷审核、数据分析、任务管理 | 同左         | 同左       | 同左       |
| 直报系统 | 直报管理、名录库管理                                         | 同左         | 同左       | 无         |

- 部门主管和普通用户的区别：
  - 权限不同，部门主管可以对部门成员进行新增和密码重置；
  - 查看数据范围不一样：部门主管可以查看所辖部门所有成员的所有问卷，但是不能编辑、删除。普通用户只能对自己心间的问卷进行编辑；
- 协管员：权限和问卷、直报的创建者一样，可以对问卷、直报进行编辑、发布、审核；
- 质控人员：可配置部分，需要问卷创建者/问卷协管员添加质控员为问卷协管员，质控人员方可进行质量控制；



### 1、问卷系统

#### （1）问卷系统主流程

![](https://raw.githubusercontent.com/Rainchen0504/picture/master/202202242026259.png)

- 用户新增问卷，编辑设置好问卷题目信息；
- 用户设置协管员，协管员权限与问卷创建者相同；
- 用户新增并设置问卷调查员；
- 用户发布问卷；
- 用户为调查员提供调查必须的资料：调查员账号与调查员二维码；
- 调查员登录调查员h5，开始调查，完成问卷并上传答卷；或直接让被调查对象直接扫码填报问卷；
- 用户对问卷进行审核；
- 用户停止问卷，调查结束；



#### （2）问卷系统管理端

##### （1）系统登陆部分

问卷系统推荐使用谷歌浏览器打开，同时接入了叮叮数据，公司内部人员可以使用钉钉账号登陆。

首次登陆时有设置强制修改密码，新旧密码不能相同，。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231559324.png" alt="image-20220223154649233" style="zoom:50%;" />

##### （2）创建问卷

问卷的新增目前设置了三种方式，即普通新增问卷、从模板新增、复制问卷。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231559813.png" alt="image-20220223155011569" style="zoom:50%;" />

##### （3）问卷编辑

问卷编辑分为两种情况：

- 未发布的问卷：新增问卷即进入编辑页面；问卷列表点击编辑进入；

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231559563.png" alt="image-20220223155637317" style="zoom:50%;" />

- 已发布的问卷：首先要停发布，才能进行编辑操作；

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231559526.png" alt="image-20220223155651767" style="zoom:50%;" />

###### 1、问卷编辑-挨个新增

在问卷编辑页面，点击【题型】，即可加入对应的题目。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231610041.png" alt="image-20220223161014127" style="zoom:50%;" />

###### 2、问卷编辑-批量新增

点击批量新增题目，查看批量新增操作说明，在弹窗中按规定格式编写题目内容，系统便可拆分字符串生成对应题目信息。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231614164.png" alt="image-20220223161405603" style="zoom:50%;" />

###### 3、问卷编辑-逻辑设置

通过显示逻辑按钮可进入逻辑设置弹窗，在该弹窗中可以对单选题、多选题和下拉题设置控制逻辑。实际效果为当选中选项设置了关联题目，就可将选中选项显示，反之未选中就是对关联题目设置隐藏。

⚠️注意：**<font color=red>显示隐藏逻辑不支持跨页配置；显示隐藏结果以最后一次操作选项影响结果为准。</font>**

![image-20220223173955011](/Users/rain_chen/Library/Application Support/typora-user-images/image-20220223173955011.png)

<img src="/Users/rain_chen/Library/Application Support/typora-user-images/image-20220223174016813.png" alt="image-20220223174016813" style="zoom:67%;" />

###### 4、问卷编辑-题目位置移动

每个题目都具有相对当前位置的上移选项，可自由控制选中题目要移动的位置。

⚠️注意：<font color=red>**当题目上移后，上移题目的控制和被控制逻辑都会被清除**</font>

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241752162.png" alt="image-20220224175204409" style="zoom:50%;" />

##### （4）问卷管理

在问卷管理页面，点击问卷管理可进入到管理问卷的页面。在管理问卷中可执行设置调查员、协管员、问卷发布、问卷审核等工作。

问卷的管理（也包括问卷的编辑）仅允许问卷创建者、协管员进行操作，上级领导可以查看，但是不支持其对问卷流程（编辑问卷、设置协管员、调查员、问卷发布等）进行操作。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241758643.png" alt="image-20220224175755669" style="zoom:50%;" />

公开问卷，会将问卷公开至公共模板库，公共模板库允许其他用户复制问卷

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202251001592.png" alt="image-20220225100114131" style="zoom:50%;" />



###### 1、问卷进度

问卷进度页面分为填报进度和按任务分配统计填报数两个模块，两个模块均使用Echarts图标直观的显示任务进度。

填报进度中可以并查看调查员的任务完成情况，包括问卷总体的填报进度，查看任务总数和已完成问卷数和未完成任务数。

按任务分配统计填报数中，可以查看已完成问卷中调查员的答卷完成数、完成答卷占比、调查任务完成率。同时还可以选择图表的类型，从而更直观的查看数据展示情况。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241847319.png" alt="image-20220224184717100" style="zoom:50%;" />

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241847088.png" alt="image-20220224184743973" style="zoom:50%;" />

###### 2、设置协管员

可以在设置协管员页面，勾选用户为问卷的协管员，可让协管员享有问卷创建者的权限，为问卷创建者分担问卷管理任务。（协管员为所有问卷管理平台使用者，即所有公司员工与外部用户，其中只有部门主管可新增外部用户）

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202250912472.png" alt="image-20220225091211334" style="zoom:50%;" />

###### 3、设置调查员

可以在设置调查员页面，勾选调查员为问卷的调查员，给调查员分配具体的调查任务与任务数。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241851956.png" alt="image-20220224185138645" style="zoom:50%;" />

###### 4、发布问卷

进入发布问卷页面后，可以点击【发布】，即可发布问卷。发布状态的问卷，会将调查员的调查任务和调查任务数下发给调查员，可以通过勾选是否限定填报IP来限制受访者可以填报的份数。发布问卷的总份数最多为99999份，下发给调查员的问卷份额总数加和等于发布问卷的总份数。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241857530.png" alt="image-20220224185731226" style="zoom:50%;" />

###### 5、二维码管理

在二维码管理页面，会呈现问卷调查员的二维码，可以方便调查员为被调查对象提供二维码或H5链接，让被调查对象直接填报问卷。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202241858005.png" alt="image-20220224185805826" style="zoom:50%;" />

###### 6、答卷管理

问卷采集端填报答卷后，用户可以做在答卷管理页面即可看到问卷的答卷。答卷管理页面支持问卷创建者及协管员对问卷进行查看答卷、查看定位、审核。

在答卷管理页面，点击【查看】即可打开查看页面，查看具体答卷内容与答卷录音；点击【定位】即可打开定位弹窗，查看调查时调查员的定位。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202250904849.png" alt="image-20220225090420543" style="zoom:50%;" />

此外，答卷管理页面支持对单个答卷进行审核和对答卷进行批量审核。（1）对单个答卷进行审核。在答卷管理页面，点击“审核”即打开审核页面，还可查看具体答卷内容与答卷录音，并对答卷进行审核。（2）还可在列表页进行够选或全部批量审核通过或驳回。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202250902188.png" alt="image-20220225090244693" style="zoom: 33%;" />

如果题目中存在附件等附加内容，可通过勾选具体答卷或全部答卷进行附件和录音的导出。当审核查看完成后，可将当前问卷导出成Execl，打包下载。

###### 7、数据分析

在该页面可以查看问卷的答题情况，并按审核状态、调查员等属性对调查结果进行分析。其中，数据分析只针对**单选题 、多选题 、下拉题 、量表题 、矩阵单选 、矩阵多选 、矩阵量表**进行分析，分析结果生成柱状图和饼图展示。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202250905453.png" alt="image-20220225090516625" style="zoom:50%;" />



### 2、直报系统

#### （1）直报系统主流程

![](https://raw.githubusercontent.com/Rainchen0504/picture/master/202202231425949.png)

- 用户新增直报，编辑好直报题目；
- 用户设置协管员，协管员权限与问卷创建者相同；
- 用户新增并设置被调查对象名录，确定调查对象类型；
- 用户发布问卷；
- 用户为被调查对象提供必须的资料：被调查对象账号与直报地址；
- 被调查对象登录直报h5，开始填报，提交直报问卷；
- 用户对直报问卷进行审核，审核通过，被调查对象直报任务完成；审核驳回，被调查对象需要重新填报直报问卷，只有填报答卷审核通过后，直报任务才算完成；
- 用户停止问卷，调查结束；



#### （2）直报系统管理端

##### （1）新增直报

直报问卷新增分为3种：新增、从模板新增、复制。与问卷不同的点在于，新增复制时，需要设置直报的调查类型。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202251333073.png" alt="image-20220225133339549" style="zoom:50%;" />

##### （2）直报编辑

直报编辑状态下，单个新增、批量新增题目，设置显示隐藏逻辑，题目位置移动等同问卷保持一致。

##### （3）直报管理

用户在直报管理页面，点击【管理直报】，可进入管理直报的页面。在管制直报中可进行设置协管员、被调查对象名录、直报发布，直报审核的工作。

直报的管理（也包括问卷的编辑）仅允许问卷创建者、协管员进行操作，上级领导可以查看，但不支持其对直报流程进行操作，如编辑直报问卷，设置协管员、被调查对象名录、直报发布，直报审核等流程。

###### 1、填报进度

用户可以在填报进度页查看直报问卷的填报进度。与问卷页面保持一致。

###### 2、设置协管员

用户可以在设置协管员页面，勾选用户为直报问卷的协管员，可让用户享有问卷创建者的权限，为问卷创建者分担问卷管理任务。（用户为所有问卷管理平台使用者，即所有公司员工与外部用户）

###### 3、名录管理

与问卷不同的是，用户管理中设置被调查对象的名录清单分为企业样本名录和个人样本名录。同时，支持新增、文件导入、名录导入这三种添加方式。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202251121443.png" alt="image-20220225112121474" style="zoom:50%;" />

单个新增和文件导入的新调查对象均会记录在系统名录中，可在名录库管理中同步查找。

未发布的直报问卷支持用户切换被调查对象类型，即可在企业和个人样本名录之间切换，但是切换的同时会**清空调查对象清单**。

###### 4、开网管理

用户可以在开网管理页面，填写开始填报时间、截止时间等，点击【发布】，即可发布直报问卷。发布状态的问卷，会将调查任务下发给被调查对象。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202202251334423.png" alt="image-20220225133429842" style="zoom:50%;" />

###### 5、数据管理和数据分析

- 直报采集端填报答卷后，用户可以做在数据管理页面即可看到直报问卷的答卷。
- 数据管理页面支持直报问卷创建者及协管员对直报问卷进行查看答卷、审核。
- 数据管理页面支持对单个直报答卷进行审核和对答卷进行批量审核。
- 用户可以在数据分析页面查看问卷的答题情况，并对调查结果进行分析。



### 3、采集端

#### （1）业务流程

问卷部分：

![image-20220330181639654](https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301816936.png)

直报部分：

![image-20220330181627057](https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301816548.png)

#### （2）直报H5

- 登录账号

被调查对象企业和个人账号均由问卷管理平台新增，个人账号微手机号，企业账号为组织机构代码。

![image-20220330183646780](https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301836787.png)

- 填报及提交

直报H5首页会显示被调查对象的所有需要填报的问卷。被调查对象可以在首页选择一份未完成的问卷，点击打开填报页面并填写直报问卷。

![image-20220330184147977](https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301841288.png)

用户点击【暂存】按钮，即暂存填报数据，暂存的问卷保存在首页的直报列表中，用户可以继续填报。

当完成必填的内容时，点击【提交】上传问卷到后台，完成一份直报问卷的提交。首页的直报列表中，对应的直报状态由未完成变更为审核中。等待问卷管理平台用户对直报进行审核。
![image-20220330184322653](https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301843947.png)

- 审核驳回

管理端用户对直报进行审核，通过流程结束，驳回则提交的问卷由审核中变为驳回

![image-20220330184606133](https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301846273.png)

点进问卷，首行显示驳回意见

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301846736.png" alt="image-20220330184649347" style="zoom:50%;" />

用户再次填报提交后问卷状态由驳回变为待审核。



#### （3）问卷H5

- 登录账号

调查员可使用手机号+密码进行登录，调查员账号由问卷管理平台新增。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301827532.png" alt="image-20220330182731648" style="zoom:50%;" />

- 调查及提交

H5首页会显示调查员的所有需要调查的问卷，点击【立即调查】即打开问卷填写页面，填写问卷。用户在问卷填写页面完成必填的内容，点击【提交】，即可完成一份问卷调查。

<img src="https://raw.githubusercontent.com/Rainchen0504/picture/master/202203301831538.png" alt="image-20220330183103711" style="zoom:50%;" />

完成的答卷可以在查看答卷中查看完成的答卷数据。


